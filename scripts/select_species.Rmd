---
title: "Species to model Phenology"
author: "steppe"
date: "2024-01-10"
output: html_document
---


```{r}
library(tidyverse)
source('functions.R')
```

```{r import species}

spp <- read.csv('../data/raw/2024species-Priorities.csv') |>
  unite('scientific_name',  genus:infraspecies, na.rm = TRUE, sep = ' ', remove = F) |>
  mutate(
    scientific_name = trimws(scientific_name)) |>
  select(scientific_name, genus, species, contract, priority, priority_source) |>
  count(scientific_name, priority)

```

```{r pull sheets for species and subset to original, eval = F}

specs1 <- lapply(spp$scientific_name, specimen_sampler, 
                 date = '1981-01-01')

specs1 <- specs1[ lapply(specs1, typeof) == 'list' ] |> bind_rows()
# specs1 <- st_read('../data/processed/high_priority_sheets/high_priority_sheets.shp', quiet = TRUE)
specs1 <- mutate(specs1, scntfcn = str_to_sentence(scientificname)) %>% 
  filter(scientificname != 'Chaenactis artemisifolia')
specs1 <- split(specs1, f = specs1$scntfcn)
specs1 <- lapply(specs1, rec_selec)
specs1 <- bind_rows(specs1)

dir.create('../data/processed/high_priority_sheets')
sf::st_write(specs1, '../data/processed/high_priority_sheets/high_priority_sheets.shp', 
             quiet = TRUE, append = F)

rm(specs1)
```

```{r flag records at outer quantiles of flowering}

# extract pca values
preds <- rast('../results/spatial/gddPCA.tif')
specs1 <- st_read('../data/processed/high_priority_sheets/high_priority_sheets.shp')

specs1 <- terra::extract(preds, specs1, bind = TRUE) |>
  st_as_sf() %>% 
  drop_na(PC1)

# flag records for manual review. 
specs1 <- split(specs1, f = specs1$scntfcn)
specs1 <- lapply(specs1, visual_review_flagger)
specs2 <- bind_rows(specs1)

priority_spp <- spp %>% 
  filter(priority %in% c('Medium', 'High') | n > 1) %>% 
  pull(scientific_name)

specs2 %>%
  drop_na(phen_flag) %>% 
  sf::st_drop_geometry() %>% 
  filter(scntfcnm %in% priority_spp) %>% 
  select(scntfcnm, accessr, doy) %>% 
  arrange(scntfcnm, doy) %>% 
  mutate(Anthesis = "") %>% 
  write.csv( '../data/processed/high_priority_sheets.csv', row.names = F)

rm(preds, specs2, specs1)
```

